FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy project files
COPY . .

# Install Python dependencies including test extras
RUN pip install --no-cache-dir -e .[test]

# Create test results directory
RUN mkdir -p /app/test-results

VOLUME ["/app/test-results"]

# Default command - run all tests with coverage
CMD ["pytest", "tests/", "-v", "--tb=short", \
     "--cov=app", "--cov-report=term-missing", "--cov-report=html:test-results/coverage", \
     "--junitxml=test-results/junit.xml", "--html=test-results/report.html", "--self-contained-html"]
