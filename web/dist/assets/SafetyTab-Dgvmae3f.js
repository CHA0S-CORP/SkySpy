import{r as e,p as a,j as s,A as t,l as n,a as i,s as l,H as r,E as o}from"./index-BLrbra3w.js";import{R as c}from"./ReplayControls-D_Wd3Pbv.js";const d={tcas_ra:"TCAS RA",tcas_ta:"TCAS TA",extreme_vs:"Extreme VS",vs_reversal:"VS Reversal",proximity_conflict:"Proximity",squawk_hijack:"Squawk 7500",squawk_radio_failure:"Squawk 7600",squawk_emergency:"Squawk 7700"};function h(e){switch(e){case"critical":return"severity-critical";case"warning":return"severity-warning";case"low":return"severity-low";default:return""}}function u(e){return d[e]||e}function p({hex:d,safetyEvents:p,safetyHours:m,setSafetyHours:f,expandedSnapshots:v,setExpandedSnapshots:x,expandedSafetyMaps:g,setExpandedSafetyMaps:j,safetyTrackData:y,setSafetyTrackData:k,safetyReplayState:_,setSafetyReplayState:w,onSelectAircraft:N,onViewHistoryEvent:b,onViewEvent:C,baseUrl:L,wsRequest:S,wsConnected:T}){const $=e.useRef({}),A=e.useRef({}),P=e.useRef({}),E=e.useRef({}),M=e.useCallback(e=>{x(a=>({...a,[e]:!a[e]}))},[x]),R=e.useCallback((e,s)=>{const t=e||0;return a.divIcon({className:"safety-aircraft-marker",html:`\n        <svg width="24" height="24" viewBox="0 0 24 24" style="transform: rotate(${t}deg)">\n          <path d="M12 2 L14 8 L20 10 L14 12 L14 18 L12 16 L10 18 L10 12 L4 10 L10 8 Z"\n                fill="${s}" stroke="#000" stroke-width="0.5"/>\n        </svg>\n      `,iconSize:[24,24],iconAnchor:[12,12]})},[]),q=e.useCallback((e,a)=>{if(!e||0===e.length)return null;if(1===e.length)return e[0];const s=[...e].reverse(),t=a/100*(s.length-1),n=Math.floor(t),i=Math.min(n+1,s.length-1),l=t-n;if(n===i||0===l)return s[n];const r=s[n],o=s[i],c=(e,a,s)=>null==e?a:null==a?e:e+(a-e)*s;return{...r,lat:c(r.lat,o.lat,l),lon:c(r.lon,o.lon,l),altitude:Math.round(c(r.altitude,o.altitude,l)),gs:c(r.gs,o.gs,l),vr:Math.round(c(r.vr,o.vr,l)),track:((e,a,s)=>{if(null==e||null==a)return e;let t=a-e;return t>180&&(t-=360),t<-180&&(t+=360),(e+t*s+360)%360})(r.track,o.track,l)}},[]),F=e.useCallback((e,s)=>{var t,n;const i=$.current[e],l=y[e];if(i&&l){if((null==(t=l.track1)?void 0:t.length)>0){const t=q(l.track1,s);if(t){A.current[`${e}_1`]&&i.removeLayer(A.current[`${e}_1`]);const n=R(t.track,"#00ff88");A.current[`${e}_1`]=a.marker([t.lat,t.lon],{icon:n}).addTo(i);const r=[...l.track1].reverse(),o=Math.floor(s/100*r.length),c=r.slice(0,Math.max(1,o)).map(e=>[e.lat,e.lon]);P.current[`${e}_1`]&&i.removeLayer(P.current[`${e}_1`]),c.length>1&&(P.current[`${e}_1`]=a.polyline(c,{color:"#00ff88",weight:3,opacity:.9}).addTo(i))}}if((null==(n=l.track2)?void 0:n.length)>0){const t=q(l.track2,s);if(t){A.current[`${e}_2`]&&i.removeLayer(A.current[`${e}_2`]);const n=R(t.track,"#ff4444");A.current[`${e}_2`]=a.marker([t.lat,t.lon],{icon:n}).addTo(i);const r=[...l.track2].reverse(),o=Math.floor(s/100*r.length),c=r.slice(0,Math.max(1,o)).map(e=>[e.lat,e.lon]);P.current[`${e}_2`]&&i.removeLayer(P.current[`${e}_2`]),c.length>1&&(P.current[`${e}_2`]=a.polyline(c,{color:"#ff4444",weight:3,opacity:.9}).addTo(i))}}}},[y,q,R]),z=e.useCallback(async(e,a)=>{const s=!g[e];if(j(a=>({...a,[e]:s})),s&&!y[e]){const s=new Date(a.timestamp),n=new Date(s.getTime()-3e5),i=new Date(s.getTime()+3e5);try{const s=async e=>{if(!e)return[];let a;if(S&&T){const s=await S("sightings",{icao_hex:e,hours:1,limit:500});if(!s||!s.sightings&&!s.results)return[];a=s}else{const s=await fetch(`${L}/api/v1/sightings?icao_hex=${e}&hours=1&limit=500`);if(a=await(async e=>{if(!e.ok)return null;const a=e.headers.get("content-type");if(!a||!a.includes("application/json"))return null;try{return await e.json()}catch{return null}})(s),!a)return[]}return((null==a?void 0:a.sightings)||(null==a?void 0:a.results)||[]).filter(e=>{const a=new Date(e.timestamp);return a>=n&&a<=i&&e.lat&&e.lon})},[t,l]=await Promise.all([s(a.icao),s(a.icao_2)]);k(s=>({...s,[e]:{track1:t,track2:l,event:a}})),w(a=>({...a,[e]:{position:50,isPlaying:!1,speed:1}}))}catch(t){console.error("Error fetching safety track data:",t)}}},[g,y,L,S,T,j,k,w]),D=e.useCallback((e,s)=>{var t,n;if(!e||$.current[s])return;const i=y[s];if(!i)return;const{track1:l,track2:r,event:o}=i,c=[...l||[],...r||[]];if(0===c.length)return;const d=o.lat||(null==(t=c[0])?void 0:t.lat),h=o.lon||(null==(n=c[0])?void 0:n.lon),p=a.map(e,{center:[d,h],zoom:11,zoomControl:!1,attributionControl:!1});if(a.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19}).addTo(p),o.lat&&o.lon&&a.circleMarker([o.lat,o.lon],{radius:10,color:"#ffaa00",fillColor:"#ffaa00",fillOpacity:.3,weight:2}).addTo(p).bindPopup(`<b>Safety Event</b><br>${o.message||u(o.event_type)}`),(null==l?void 0:l.length)>1){const e=[...l].reverse().map(e=>[e.lat,e.lon]);a.polyline(e,{color:"#00ff88",weight:2,opacity:.2}).addTo(p)}if((null==r?void 0:r.length)>1){const e=[...r].reverse().map(e=>[e.lat,e.lon]);a.polyline(e,{color:"#ff4444",weight:2,opacity:.2}).addTo(p)}if(c.length>0){const e=a.latLngBounds(c.map(e=>[e.lat,e.lon]));p.fitBounds(e.pad(.1))}$.current[s]=p;const m=_[s]||{position:50};setTimeout(()=>F(s,m.position),100)},[y,_,F]),V=e.useCallback((e,a)=>{w(s=>({...s,[e]:{...s[e],position:a}})),F(e,a)},[w,F]),H=e.useCallback(e=>{w(a=>{const s=a[e]||{position:0,isPlaying:!1,speed:1};if(s.isPlaying)return E.current[e]&&cancelAnimationFrame(E.current[e]),{...a,[e]:{...s,isPlaying:!1}};{let t=s.position<=0?0:s.position,n=performance.now();const i=s.speed,l=a=>{const s=a-n;n=a;if(t+=s/200*i,t>=100)return w(a=>({...a,[e]:{...a[e],position:100,isPlaying:!1}})),void F(e,100);w(a=>({...a,[e]:{...a[e],position:t}})),F(e,t),E.current[e]=requestAnimationFrame(l)};return E.current[e]=requestAnimationFrame(l),{...a,[e]:{...s,isPlaying:!0}}}})},[w,F]),B=e.useCallback(e=>{E.current[e]&&cancelAnimationFrame(E.current[e]);const a=_[e]||{speed:1};w(s=>({...s,[e]:{position:0,isPlaying:!1,speed:a.speed}})),F(e,0)},[_,w,F]),O=e.useCallback(e=>{E.current[e]&&cancelAnimationFrame(E.current[e]);const a=_[e]||{speed:1};w(s=>({...s,[e]:{position:100,isPlaying:!1,speed:a.speed}})),F(e,100)},[_,w,F]),G=e.useCallback(e=>{E.current[e]&&cancelAnimationFrame(E.current[e]);const a=_[e]||{speed:1};w(s=>({...s,[e]:{position:50,isPlaying:!1,speed:a.speed}})),F(e,50)},[_,w,F]),I=e.useCallback((e,a)=>{w(s=>({...s,[e]:{...s[e],speed:a}}))},[w]),U=e.useCallback(e=>{var a;const s=y[e],t=_[e];if(!s||!t)return null;const n=(null==(a=s.track1)?void 0:a.length)>0?s.track1:s.track2;if(!n||0===n.length)return null;const i=q(n,t.position);return(null==i?void 0:i.timestamp)?new Date(i.timestamp).toLocaleTimeString():null},[y,_,q]);e.useEffect(()=>()=>{Object.keys($.current).forEach(e=>{$.current[e]&&$.current[e].remove(),E.current[e]&&cancelAnimationFrame(E.current[e])})},[]);const Z=(e,a)=>{var t,n,i,l,r,o,c;return e?s.jsxs("div",{className:"snapshot-section",children:[a&&s.jsx("div",{className:"snapshot-label",children:a}),s.jsxs("div",{className:"snapshot-grid",children:[e.flight&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Callsign"}),s.jsx("span",{children:e.flight})]}),e.hex&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"ICAO"}),(null==(t=e.hex)?void 0:t.toLowerCase())!==(null==d?void 0:d.toLowerCase())?s.jsx("button",{className:"icao-link",onClick:()=>null==N?void 0:N(e.hex),children:e.hex}):s.jsx("span",{children:e.hex})]}),e.lat&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Lat"}),s.jsx("span",{children:null==(n=e.lat)?void 0:n.toFixed(5)})]}),e.lon&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Lon"}),s.jsx("span",{children:null==(i=e.lon)?void 0:i.toFixed(5)})]}),e.alt_baro&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Alt (baro)"}),s.jsxs("span",{children:[null==(l=e.alt_baro)?void 0:l.toLocaleString()," ft"]})]}),e.alt_geom&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Alt (geom)"}),s.jsxs("span",{children:[null==(r=e.alt_geom)?void 0:r.toLocaleString()," ft"]})]}),e.gs&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Ground Speed"}),s.jsxs("span",{children:[null==(o=e.gs)?void 0:o.toFixed(0)," kts"]})]}),void 0!==e.track&&null!==e.track&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Track"}),s.jsxs("span",{children:[null==(c=e.track)?void 0:c.toFixed(0),"°"]})]}),e.baro_rate&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Baro Rate"}),s.jsxs("span",{children:[e.baro_rate>0?"+":"",e.baro_rate," fpm"]})]}),e.geom_rate&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Geom Rate"}),s.jsxs("span",{children:[e.geom_rate>0?"+":"",e.geom_rate," fpm"]})]}),e.squawk&&s.jsxs("div",{className:"snapshot-item",children:[s.jsx("span",{children:"Squawk"}),s.jsx("span",{children:e.squawk})]})]})]}):null};return s.jsxs("div",{className:"detail-safety",id:"panel-safety",role:"tabpanel","aria-labelledby":"tab-safety",children:[s.jsxs("div",{className:"safety-filter",children:[s.jsx("label",{htmlFor:"safety-time-range",children:"Time Range:"}),s.jsxs("select",{id:"safety-time-range",value:m,onChange:e=>f(Number(e.target.value)),children:[s.jsx("option",{value:1,children:"Last 1 hour"}),s.jsx("option",{value:6,children:"Last 6 hours"}),s.jsx("option",{value:12,children:"Last 12 hours"}),s.jsx("option",{value:24,children:"Last 24 hours"}),s.jsx("option",{value:48,children:"Last 48 hours"}),s.jsx("option",{value:72,children:"Last 72 hours"}),s.jsx("option",{value:168,children:"Last 7 days"})]})]}),0===p.length?s.jsxs("div",{className:"detail-empty",role:"status",children:[s.jsx(t,{size:48,"aria-hidden":"true"}),s.jsx("p",{children:"No safety events"}),s.jsx("span",{children:"No safety events recorded for this aircraft in the selected time range"})]}):s.jsxs("div",{className:"safety-events-list",children:[s.jsxs("p",{className:"safety-count","aria-live":"polite",children:[p.length," safety event",1!==p.length?"s":""," in the last ",m," hour",1!==m?"s":""]}),p.map((e,a)=>{var t,p,m,f,x,j;const k=e.id||a,w=e.aircraft_snapshot||e.aircraft_snapshot_2,L=v[k],S=null==d?void 0:d.toLowerCase(),T=(null==(t=e.icao)?void 0:t.toLowerCase())===S,A=T?e.icao_2:e.icao,P=T?e.callsign_2:e.callsign;return s.jsxs("article",{className:`safety-event-item ${h(e.severity)}`,children:[s.jsxs("div",{className:"safety-event-header",children:[s.jsx("span",{className:`safety-severity-badge ${h(e.severity)}`,children:null==(p=e.severity)?void 0:p.toUpperCase()}),s.jsx("span",{className:"safety-event-type",children:u(e.event_type)}),s.jsx("time",{className:"safety-event-time",dateTime:e.timestamp,children:new Date(e.timestamp).toLocaleString()})]}),s.jsx("div",{className:"safety-event-message",children:e.message}),e.details&&s.jsxs("div",{className:"safety-event-details",children:[e.details.altitude&&s.jsxs("span",{children:["Alt: ",null==(m=e.details.altitude)?void 0:m.toLocaleString(),"ft"]}),e.details.vertical_rate&&s.jsxs("span",{children:["VS: ",e.details.vertical_rate>0?"+":"",e.details.vertical_rate,"fpm"]}),e.details.distance_nm&&s.jsxs("span",{children:["Dist: ",e.details.distance_nm,"nm"]}),e.details.altitude_diff_ft&&s.jsxs("span",{children:["ΔAlt: ",e.details.altitude_diff_ft,"ft"]}),A&&s.jsxs("span",{className:"safety-other-aircraft",children:["With:"," ",N?s.jsx("button",{className:"safety-aircraft-link",onClick:()=>N(A),title:`View ${A}`,children:P||A}):s.jsx("span",{children:P||A})]})]}),s.jsxs("div",{className:"safety-event-actions",children:[w&&s.jsxs("button",{className:"snapshot-toggle",onClick:()=>M(k),"aria-expanded":L,children:[L?s.jsx(n,{size:14,"aria-hidden":"true"}):s.jsx(i,{size:14,"aria-hidden":"true"}),L?"Hide":"Show"," Telemetry"]}),s.jsxs("button",{className:"map-toggle-btn small "+(g[k]?"active":""),onClick:()=>z(k,e),children:[s.jsx(l,{size:14,"aria-hidden":"true"}),g[k]?"Hide Map":"Show Map"]}),b&&s.jsxs("button",{className:"history-link-btn small",onClick:()=>b(e.id||k),title:"View in History with expanded map",children:[s.jsx(r,{size:14,"aria-hidden":"true"}),"View in History"]}),C&&e.id&&s.jsxs("button",{className:"view-details-btn small",onClick:()=>C(e.id),title:"View full event details page",children:[s.jsx(o,{size:14,"aria-hidden":"true"}),"View Details"]})]}),L&&w&&s.jsxs("div",{className:"snapshot-container",children:[e.aircraft_snapshot&&Z(e.aircraft_snapshot,e.aircraft_snapshot_2?e.aircraft_snapshot.flight||e.icao:null),e.aircraft_snapshot_2&&Z(e.aircraft_snapshot_2,e.aircraft_snapshot_2.flight||e.icao_2)]}),g[k]&&y[k]&&s.jsxs("div",{className:"safety-map-container",children:[s.jsx("div",{className:"safety-event-map",ref:e=>{e&&g[k]&&!$.current[k]&&setTimeout(()=>D(e,k),50)}}),s.jsx(c,{isPlaying:null==(f=_[k])?void 0:f.isPlaying,position:(null==(x=_[k])?void 0:x.position)||50,timestamp:U(k),onPlayToggle:()=>H(k),onSkipToStart:()=>B(k),onSkipToEnd:()=>O(k),onJumpToEvent:()=>G(k),onPositionChange:e=>V(k,e),speed:(null==(j=_[k])?void 0:j.speed)||1,onSpeedChange:e=>I(k,e)}),s.jsxs("div",{className:"safety-map-legend",children:[s.jsxs("div",{className:"legend-item clickable",onClick:()=>null==N?void 0:N(e.icao),children:[s.jsx("span",{className:"legend-marker ac1-marker"}),s.jsx("span",{className:"legend-callsign",children:e.callsign||e.icao})]}),e.icao_2&&s.jsxs("div",{className:"legend-item clickable",onClick:()=>null==N?void 0:N(e.icao_2),children:[s.jsx("span",{className:"legend-marker ac2-marker"}),s.jsx("span",{className:"legend-callsign",children:e.callsign_2||e.icao_2})]}),s.jsxs("div",{className:"legend-item",children:[s.jsx("span",{className:"legend-marker event-marker"}),s.jsx("span",{children:"Event Location"})]})]})]})]},k)})]})]})}export{p as SafetyTab};
